{% extends 'recipe/base.html' %}
{% block content%}
{%load crispy_forms_tags%}


<h3> Etapes de pr√©paration :</h3>

<td> <a href={% url 'recettes-update' pk%} class="card-link">retour</a> </td>

<form id="pet_form"  action="{% url 'create_recipe_process' pk %}" method="post" enctype="multipart/form-data">

    {% csrf_token %}
<!-- {{ form | crispy }}-->    
  
    {{ formset.management_form }}
    {% for form in formset %}



    <div class="image-form d-flex justify-content-between"  id="recipeForm"  >

        {{form.step}}
        {{form.DELETE}}

        <button class="align-self-center btn btn-danger delete-image-form">supprimer</button>
    </div>


    {% endfor %}


    <input type="submit" class="btn btn-primary my-3" value="Terminer" name='terminerBttn'/>  </button>
    <button id="add-image-form" class="btn btn-primary my-3">ajouter une nouvelle etape</button>
    <input type="hidden" name="counter_newid" value="3" id="id_counter_new_id">
  
</form>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>


    <script>
    
    const imageForm = document.getElementsByClassName("image-form");
    const mainForm = document.querySelector("#pet_form");
    const addImageFormBtn = document.querySelector("#add-image-form");
    const submitFormBtn = document.querySelector('[type="submit"]');
    const totalForms = document.getElementById("id_process_recipe-TOTAL_FORMS");
    
    const counterID = document.getElementById("id_counter_new_id");
    
    function updateForms() {
        let formCount = imageForm.length ;
        let count = 0;
        for (let form of imageForm) {
            const formRegex = RegExp(`process_recipe-(\\d){1}-`, 'g');
            form.innerHTML = form.innerHTML.replace(formRegex, `process_recipe-${count++}-`)
        }
    }
    
    addImageFormBtn.addEventListener("click", function (event) {
        event.preventDefault();
        //let formCount = imageForm.length ;
        const formCount = imageForm.length
        //const formCount = parseInt(counterID.getAttribute('value')) + 1 ;
        const newImageForm = imageForm[0].cloneNode(true);
        const formRegex = RegExp(`process_recipe-(\\d){1}-`, 'g');
    
        newImageForm.innerHTML = newImageForm.innerHTML.replace(formRegex, `process_recipe-${formCount}-`);
        mainForm.insertBefore(newImageForm, submitFormBtn);
        //totalForms.setAttribute('value', imageForm.length);
        totalForms.setAttribute('value', formCount + 1);
        
        //counterID.setAttribute('value', formCount);
    
    });
    
    mainForm.addEventListener("click", function (event) {
        let formCount = imageForm.length ;
        const formCount2 = parseInt(counterID.getAttribute('value')) + 1 ;

        if (event.target.classList.contains("delete-image-form")) {
            event.preventDefault();
            //event.target.parentElement.remove();
            //formCount--;
            //updateForms();

            //totalForms.setAttribute('value', imageForm.length);
            //totalForms.setAttribute('value', 100);

            
            event.target.parentElement.querySelectorAll('[id$="-DELETE"]')[0].checked = true;
            console.log(event.target.parentElement.querySelectorAll('[id$="-DELETE"]')[0].checked)
            //console.log(document.querySelectorAll('[id$="-DELETE"]'))
            console.log('Test')
            
            //event.target.parentElement.remove();
            event.target.parentElement.style.visibility = 'hidden';
            event.target.parentElement.style.height=0;
        }
    });
    </script>
    <script>
        var del = document.querySelectorAll('[id$="-DELETE"]')
    
        for (let i=0; i < del.length; i++ ) {
            console.log(del[i]);
            del[i].style.visibility = 'hidden';
        }
            
    </script>
    
    
    

    
    
{% endblock %}
